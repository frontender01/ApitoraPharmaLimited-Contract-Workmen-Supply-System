<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workforce Management System</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; margin:0; }
    h1 { font-size: 2rem; color: #2563eb; margin-bottom: 0; }
    header p { color: #555; }
    main { max-width: 720px; margin: auto; padding: 2rem 1rem; }
    .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 2px 8px 0 #0001; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333; }
    input, select { width: 100%; padding: 0.6rem; border-radius: 5px; border: 1px solid #bbb; font-size: 1rem; margin-bottom: 0.5rem; box-sizing: border-box; }
    .shift-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .shift-tab { flex: 1; background: #f0f4ff; border: 1px solid #2563eb; border-radius: 6px; font-weight: bold; color: #2563eb; padding: 0.5rem; cursor: pointer; transition: background 0.2s;}
    .shift-tab.active { background: #2563eb; color: #fff; }
    #submit-btn { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 0.7rem; font-size: 1rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 1rem; }
    #submit-btn.loading { background: #aaa; }
    .summary-cards { display: flex; gap: 1rem; margin-bottom: 1rem; }
    .summary-card { flex: 1; background: #eaf2ff; border-radius: 7px; padding: 1rem; text-align: center;}
    .summary-card h3 { color: #2563eb; font-size: 1rem; margin-bottom: 0.2rem;}
    .summary-card p { font-size: 2rem; margin: 0;}
    table { width: 100%; border-collapse: collapse; margin: 1rem 0;}
    th, td { padding: 0.6rem; border-bottom: 1px solid #eee; text-align: left;}
    th { color: #2563eb; background: #f6faff; font-size: 0.95rem;}
    .toast { position: fixed; top:1rem; right:1rem; z-index:9000; padding:0.8rem 1.5rem; border-radius:8px; color:#fff; font-weight:bold; opacity:0.96; }
    .toast.success { background:#10b981; }
    .toast.error { background:#dc2626; }
    @media (max-width: 700px) {
      .summary-cards { flex-direction: column; gap: 0.7rem; }
    }
  </style>
</head>
<body>
  <main>
    <header style="text-align:center; margin-bottom:2rem;">
      <h1>Workforce Management System</h1>
      <p>Your Company</p>
    </header>
    <div style="display:flex; justify-content:center; gap:1rem; margin-bottom:1.5rem;">
      <button id="contractor-tab" class="shift-tab active" style="flex:unset;">Contractor</button>
      <button id="hr-tab" class="shift-tab" style="flex:unset;">HR Dashboard</button>
    </div>
    <!-- Contractor Entry -->
    <section id="contractor-interface">
      <form class="card" autocomplete="off">
        <label for="contractor-select">Select Contractor</label>
        <select id="contractor-select" required>
          <option value="">Choose a contractor...</option>
          <option value="ABC Construction Ltd">ABC Construction Ltd</option>
          <option value="XYZ Engineering Corp">XYZ Engineering Corp</option>
          <option value="Delta Industrial Services">Delta Industrial Services</option>
          <option value="Prime Contractors Inc">Prime Contractors Inc</option>
          <option value="Elite Workforce Solutions">Elite Workforce Solutions</option>
        </select>
        <label for="date-select">Date</label>
        <input type="date" id="date-select" required>
        <label>Select Shift</label>
        <div class="shift-tabs" id="shift-tabs">
          <div class="shift-tab active" data-shift="A">A Shift<br><span style="font-size: 0.85em;">6:00 AM</span></div>
          <div class="shift-tab" data-shift="G">G Shift<br><span style="font-size: 0.85em;">9:00 AM</span></div>
          <div class="shift-tab" data-shift="B">B Shift<br><span style="font-size: 0.85em;">2:00 PM</span></div>
          <div class="shift-tab" data-shift="C">C Shift<br><span style="font-size: 0.85em;">10:00 PM</span></div>
        </div>
        <label>Manpower Allocation</label>
        <div id="manpower-blocks"></div>
        <button id="submit-btn" type="button">Submit Manpower Data</button>
      </form>
    </section>
    <!-- HR Dashboard -->
    <section id="hr-interface" style="display:none;">
      <div class="card">
        <label for="hr-date-select">Select Date</label>
        <input type="date" id="hr-date-select">
        <label for="hr-shift-select">Select Shift</label>
        <select id="hr-shift-select">
          <option value="A">A Shift (6:00 AM)</option>
          <option value="G">G Shift (9:00 AM)</option>
          <option value="B">B Shift (2:00 PM)</option>
          <option value="C">C Shift (10:00 PM)</option>
        </select>
        <button id="export-btn" style="background:#10b981; color:#fff; margin-top:0.8rem; border:none; border-radius:6px; padding:0.7rem; font-size: 1rem; font-weight:bold;width:100%;">Export Report</button>
      </div>
      <div class="summary-cards">
        <div class="summary-card"><h3>Total Manpower</h3><p id="total-manpower">0</p></div>
        <div class="summary-card"><h3>Active Contractors</h3><p id="active-contractors">0</p></div>
        <div class="summary-card"><h3>Blocks Covered</h3><p id="blocks-covered">0</p></div>
      </div>
      <div class="card">
        <h3 style="color:#2563eb;">Manpower Breakdown</h3>
        <table>
          <thead>
            <tr>
              <th>Block</th>
              <th>Contractor</th>
              <th>Manpower</th>
              <th>Shift</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="hr-table-body"></tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    // *** REPLACE with your own Google Apps Script Web App URL after deploying the script! ***
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyPn-2Rcvy929cLeIf7r4JlE-5rhrLSju8E3KlsarqQtlX4huk_s-cj4P7gLU1y956G0A/exec";

    // App logic
    const blocks = [
      'Block A - Production','Block B - Assembly','Block C - Quality Control','Block D - Packaging',
      'Block E - Maintenance','Block F - Logistics','Block G - Administration','Block H - Security'
    ];
    let currentShift = 'A';
    let localRecords = [];
    let isLoading = false;

    function showToast(msg, type = "success") {
      const toast = document.createElement('div');
      toast.className = "toast " + type;
      toast.innerText = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3200);
    }

    function setupShifts() {
      const shiftTabs = document.querySelectorAll('.shift-tab');
      shiftTabs.forEach(tab => {
        tab.onclick = function() {
          shiftTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentShift = tab.getAttribute('data-shift');
        }
      });
    }

    function renderManpowerBlocks() {
      const container = document.getElementById('manpower-blocks');
      container.innerHTML = "";
      blocks.forEach((block, i) => {
        const div = document.createElement('div');
        div.style = "display:flex;gap:0.5rem;align-items:center;margin-bottom:0.3rem;";
        div.innerHTML = `<span style="flex:1">${block}</span>
          <input type="number" id="manpower-${i}" min="0" placeholder="0" style="width:80px;">`;
        container.appendChild(div);
      });
    }

    function setToday(id) {
      const el = document.getElementById(id);
      el.value = new Date().toISOString().split("T")[0];
    }

    function switchToContractor() {
      document.getElementById('contractor-tab').classList.add('active');
      document.getElementById('hr-tab').classList.remove('active');
      document.getElementById('contractor-interface').style.display = '';
      document.getElementById('hr-interface').style.display = 'none';
    }
    function switchToHR() {
      document.getElementById('hr-tab').classList.add('active');
      document.getElementById('contractor-tab').classList.remove('active');
      document.getElementById('contractor-interface').style.display = 'none';
      document.getElementById('hr-interface').style.display = '';
      updateHRDashboard();
    }
    document.getElementById('contractor-tab').onclick = switchToContractor;
    document.getElementById('hr-tab').onclick = switchToHR;

    document.getElementById('submit-btn').onclick = async function(e) {
      if(isLoading) return;
      const contractorName = document.getElementById('contractor-select').value; const date = document.getElementById('date-select').value;
      if (!contractorName) return showToast("Please select a contractor", "error");
      if (!date) return showToast("Please select a date", "error");
      let manpowerData = [];
      blocks.forEach((block, i) => {
        const manpower = parseInt(document.getElementById(`manpower-${i}`).value) || 0;
        if(manpower > 0) {
          manpowerData.push({
            contractor_name: contractorName,
            shift: currentShift,
            date: date,
            block_name: block,
            manpower: manpower,
            submitted_at: new Date().toISOString()
          });
        }
      });
      if(manpowerData.length === 0) return showToast("Please enter manpower for at least one block", "error");

      isLoading = true; this.classList.add("loading");
      let errors = 0;
      for (let record of manpowerData) {
        try {
          const res = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST", body: JSON.stringify(record),
            headers: { "Content-Type": "application/json" }
          });
          if (!res.ok) throw new Error(await res.text());
          localRecords.push(record);
        } catch (err) {
          errors++; showToast("Error submitting data: " + err.message, "error");
        }
      }
      if(errors===0) showToast("Manpower data submitted successfully!", "success");
      blocks.forEach((_, i) => document.getElementById(`manpower-${i}`).value = "");
      this.classList.remove("loading");
      isLoading = false;
    };

    function updateHRDashboard() {
      const selDate = document.getElementById('hr-date-select').value;
      const selShift = document.getElementById('hr-shift-select').value;
      const filtered = localRecords.filter(r => r.date === selDate && r.shift === selShift);

      document.getElementById('total-manpower').innerText =
        filtered.reduce((sum, r) => sum + (+r.manpower || 0), 0);
      document.getElementById('active-contractors').innerText =
        [...new Set(filtered.map(r => r.contractor_name))].length;
      document.getElementById('blocks-covered').innerText =
        [...new Set(filtered.map(r => r.block_name))].length;
      // Table
      const tbody = document.getElementById('hr-table-body');
      tbody.innerHTML = "";
      if(filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888;">No data for selection</td></tr>`;
        return;
      }
      filtered.forEach(r => {
        tbody.innerHTML += `<tr>
        <td>${r.block_name}</td><td>${r.contractor_name}</td>
        <td>${r.manpower}</td><td>${r.shift} Shift</td><td>${r.date}</td>
        </tr>`;
      });
    }

    document.getElementById('hr-date-select').onchange = updateHRDashboard;
    document.getElementById('hr-shift-select').onchange = updateHRDashboard;

    document.getElementById('export-btn').onclick = function() {
      const selDate = document.getElementById('hr-date-select').value;
      const selShift = document.getElementById('hr-shift-select').value;
      const filtered = localRecords.filter(r => r.date === selDate && r.shift === selShift);
      if(filtered.length === 0) return showToast("No data to export", "error");
      const headers = ['Block', 'Contractor', 'Manpower', 'Shift', 'Date'];
      let csv = [headers.join(",")];
      filtered.forEach(r => {
        csv.push(`"${r.block_name}","${r.contractor_name}",${r.manpower},"${r.shift} Shift",${r.date}`);
      });
      const blob = new Blob([csv.join("\n")], {type: "text/csv"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `workforce-report-${selDate}-${selShift}-shift.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      showToast("Report exported!", "success");
    };

    renderManpowerBlocks();
    setupShifts();
    setToday('date-select');
    setToday('hr-date-select');
  </script>
</body>
</html>
